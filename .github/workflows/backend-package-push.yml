name: backend-package-push-action
run-name: Create new Midas backend package
on:
  push:
    branches: ["main"]
  release:
    types: ["published"]

jobs:
  ctr_check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Enter client directory
      run: cd client
    - name: Build the Docker image
      run: docker build . --tag midas_backend:test
    - name: Test the Docker image
      run: |
        docker run -d -p 4000:4000 midas_backend:test
        sleep 3
    - name: Get HTTP response from "localhost:4000"
      run: "curl -f localhost:4000"
  
  ctr_push:
    needs: ["ctr_check"]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Enter client directory
      run: cd client
    - name: Build and publish an image for ${{ github.repository }}
      uses: macbre/push-to-ghcr@v13
      with:
        image_name: ${{ github.repository }}-backend
        github_token: ${{ secrets.GITHUB_TOKEN }}

  telegram_notify:
    needs: ["ctr_push"]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        message: ["New backend package has been pushed to Midas repository"]
    steps:
      - name: Notify owner in Telegram
        run: 'curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage -d chat_id=${{ secrets.TELEGRAM_ID }} -d text="${{ matrix.message }}" > /dev/null'